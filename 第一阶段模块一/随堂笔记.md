​                                                                            Mybatis

1 自定义持久层框架

1.1 传统JDBC操作问题及解决思路

​     (1)数据库连接、释放频繁造成系统资源浪费      ---- >连接池

​     (2)sql语句硬编码，不利于维护    ---- >mapper配置文件

​     (3)因sql语句条件不一致，sql变化会牵一发动全身    ---- > mapper配置文件

​     (4)结果集解析存在硬编码，sql变化导致解析发生变化，不利于系统维护   ---->反射及内省



1.2 自定义框架设计思路

​    使用端：

​          提供核心配置文件（sqlMapconfig.xml）

​          提供sql语句配置文件（Mapper.xml）

​    框架层设计：

​          （1）读取配置文件，输出对应javaBean（Configuration：存放数据库基本信息，及MappwedStatement；MappwedStatement：sql语句、id，参数类型、结果集类型）

​           （2）解析配置文件

​           （3）创建sqlSessionFactory

​           （4）创建sqlSession接口以及实现类，分钟CRUD方法

1.3 自定义框架优化

​            缺陷：a 、dao实现类存在重复代码（如创建sqlSession，调用sqlSession，关闭sqlSession等）

​                       b、dao实现类存在硬编码，参数statementId，调用时都存在拼接

鉴于此：解决思路：使用代理模式来创建接口的代理对象

  

2 Mybatis相关概念

​    2.1  Mybatis优势 

​           半自动化持久型框架，对开发而言将sql开放出来，便于优化；sql与java编码分开，功能边界清晰，业务与数据相分离

 

3 Mybatis基本应用

​    3.1  Mybatis开发流程

​             （1）    添加 Mybatis依赖坐标

​             （2）创建User数据表

​             （3）编写User实体类

​             （4）编写映射文件UsreMapper.xml

​             （5）编写核心配置文件SqlMapConfig.xml

   Mapper接口开发规范：

​              （1）Mapper.xml文件中的nameSpace与Mapper接口的完全限定类名相同

​              （2）Mapper接口方法名和Mapper.xml中定义的每个statement的id相同

​              （3）Mapper接口方法输入参数类型与Mapper.xml中的parameterType的类型相同

​              （4）Mapper接口方法的输出参数跟Mapper.xml中的resultType的类型相同



4  Mybatis复杂映射开发

​     注意点：根据返回结果集的差异性，需要注意resultType与resultMap的区别

5  Mybatis 注解开发（常用注解）

​     @insert  新增

​     @ Update  更新

​     @Select   查询

​     @Result 实现结果集封装

​     @Results 封装多个结果集，可与与result一起使用

​     @One 一对一结果集封装

​     @Many一对多结果集封装



6  Mybatis缓存

​     一级缓存：SqlSession级别的缓存，早操作数据库时需要构造SqlSession对象，在对象中有一个数据结果（HashMap）用于存储缓存数据，不同的SqlSession之间的缓存数据区域是互不影响的

   二级缓存：mapper级别的缓存，多个SqlSession去操作同一个mapper的sql语句，多个SqlSession可以共用二级缓存，二级缓存是跨SqlSession的



7  Mybatis插件

​    mybatis可以编写针对Executor、StatementHandler、ParameterHandler、ResultSetHandler四个接口的插件，mybatis使用JDK的动态代理为需要拦截的接口生成代理对象，然后实现接口的拦截方法，所以当执行需要拦截的接口方法时，会进入拦截方法

自定义插件实现：

​     1.编写类实现Intercepror接口并覆写intercept方法及plugin方法，并根据业务需求可进行增强

​     2.设置插件的签名，告诉mybatis拦截哪个对象的哪个方法

​     3.最后将插件注册到全局配置文件中

8 Mybatis架构原理

​    8.1 功能架构分层

​            API接口层：提供外部使用的的接口API，开发人员根据这些API操作数据库（Mybatis和数据库交互方式：API接口，Mapper代理）

​           数据处理层：复杂具体sql的查询，解析，执行和执行结果映射处理等，主要是根据调用请求完成一次数据库操作

​           基础支撑层：复杂最基础的功能支撑，包括连接管理、事务管理、配置加载和缓存处理，为上层数据处理层提供支撑



主要构件及其对应关系：

​         Sqlsession：主要顶层API，表示和数据库交互的会话，完成必要数据库增删改查功能

​         Executor：Mybatis执行器，是其调用核心，复杂SQL语句的生产和查询缓存的维护

​         StatementHandler：封装及负责对JDBC statement操作

​         ParameterHandler：负责传递的参数转化为JDBC statement所需要的的参数

​         ResultSetHandler：负责返回结果集的转化

​         TypeHanlder：负责java数据类型和jdbc数据类型之间映射和转换

​         MappedStatement：维护了一条select|update|delete|insert节点的封装

​         SqlSource：负责根据用户传递的parameterObject，动态的生产sql语句，将信息封装到Boundsql对象中

​        Boundsql：表示动态生成sql语句以及相应的参数信息



9 源码分析

​    重点

 10 设计模式

​       构建者模式

​      工厂模式

​       代理模式





